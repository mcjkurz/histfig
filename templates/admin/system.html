{% extends "admin/base.html" %}

{% block title %}System - Historical Figures Admin{% endblock %}

{% block content %}
<style>
    .system-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    
    .system-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .system-card-header {
        padding: 1rem 1.25rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .system-card-header h3 {
        margin: 0;
        font-size: 1rem;
        color: #2c3e50;
    }
    
    .system-card-body {
        padding: 1.25rem;
    }
    
    .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .stat-row:last-child {
        border-bottom: none;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }
    
    .stat-value {
        font-weight: 600;
        color: #2c3e50;
    }
    
    .stat-value.success { color: #27ae60; }
    .stat-value.warning { color: #f39c12; }
    .stat-value.error { color: #e74c3c; }
    
    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .btn-primary {
        background: #3498db;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2980b9;
    }
    
    .btn-warning {
        background: #f39c12;
        color: white;
    }
    
    .btn-warning:hover {
        background: #d68910;
    }
    
    .btn-success {
        background: #27ae60;
        color: white;
    }
    
    .btn-success:hover {
        background: #229954;
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .sessions-list {
        max-height: 300px;
        overflow-y: auto;
        margin-top: 1rem;
    }
    
    .session-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 0.5rem;
        font-size: 0.85rem;
    }
    
    .session-item:last-child {
        margin-bottom: 0;
    }
    
    .session-id {
        font-family: monospace;
        color: #3498db;
    }
    
    .figure-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .figure-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .figure-item:last-child {
        border-bottom: none;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        color: #999;
        padding: 2rem;
    }
    
    .refresh-time {
        font-size: 0.75rem;
        color: #999;
    }
</style>

<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2>System Status</h2>
        <span class="refresh-time" id="last-refresh">Last refresh: Never</span>
    </div>
</div>

<div class="system-grid">
    <!-- Sessions Panel -->
    <div class="system-card">
        <div class="system-card-header">
            <h3>ðŸ’¬ Active Sessions</h3>
            <button class="btn btn-primary" onclick="loadSessions()" id="btn-refresh-sessions">
                â†» Refresh
            </button>
        </div>
        <div class="system-card-body">
            <div id="sessions-stats">
                <div class="stat-row">
                    <span class="stat-label">Active sessions</span>
                    <span class="stat-value" id="active-count">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Session timeout</span>
                    <span class="stat-value" id="timeout-hours">-</span>
                </div>
            </div>
            
            <div id="sessions-list" class="sessions-list">
                <div class="empty-state">Click Refresh to load sessions</div>
            </div>
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                <button class="btn btn-warning" onclick="cleanupSessions()" id="btn-cleanup">
                    ðŸ§¹ Cleanup Expired Sessions
                </button>
                <div id="cleanup-result" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
            </div>
        </div>
    </div>
    
    <!-- RAG Status Panel -->
    <div class="system-card">
        <div class="system-card-header">
            <h3>ðŸ“š RAG System Status</h3>
            <button class="btn btn-primary" onclick="loadRagStatus()" id="btn-refresh-rag">
                â†» Refresh
            </button>
        </div>
        <div class="system-card-body">
            <div id="rag-stats">
                <div class="stat-row">
                    <span class="stat-label">Figure Manager</span>
                    <span class="stat-value" id="figure-manager-status">-</span>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <strong style="font-size: 0.9rem; color: #666;">Figures:</strong>
                <div id="figures-list" class="figure-list" style="margin-top: 0.5rem;">
                    <div class="empty-state">Click Refresh to load status</div>
                </div>
            </div>
            
            <div id="rag-errors" style="margin-top: 1rem; display: none;">
                <strong style="color: #e74c3c;">Errors:</strong>
                <ul id="rag-errors-list" style="margin: 0.5rem 0; padding-left: 1.5rem; color: #e74c3c;"></ul>
            </div>
            
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                <button class="btn btn-warning" onclick="rebuildBm25()" id="btn-rebuild-bm25">
                    ðŸ”„ Rebuild BM25 Indexes
                </button>
                <small style="display: block; margin-top: 0.4rem; color: #999;">Rebuilds keyword search indexes for all figures.</small>
                <div id="bm25-result" style="margin-top: 0.5rem; font-size: 0.85rem;"></div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="csrf-token" value="{{ csrf_token }}">

<script>
const csrfToken = document.getElementById('csrf-token').value;

function updateRefreshTime() {
    document.getElementById('last-refresh').textContent = 
        'Last refresh: ' + new Date().toLocaleTimeString();
}

async function loadSessions() {
    const btn = document.getElementById('btn-refresh-sessions');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading-spinner"></span> Loading...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/admin/api/debug/sessions');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        document.getElementById('active-count').textContent = data.active_sessions;
        document.getElementById('timeout-hours').textContent = data.timeout_hours + ' hours';
        
        const listEl = document.getElementById('sessions-list');
        if (data.sessions && data.sessions.length > 0) {
            listEl.innerHTML = data.sessions.map(s => `
                <div class="session-item">
                    <span class="session-id">${s.session_id}</span>
                    <br>
                    <span style="color: #666;">
                        Figure: <strong>${s.figure || 'None'}</strong> | 
                        Messages: ${s.messages} | 
                        Inactive: ${s.inactive_minutes}m
                    </span>
                </div>
            `).join('');
        } else {
            listEl.innerHTML = '<div class="empty-state">No active sessions</div>';
        }
        
        updateRefreshTime();
    } catch (error) {
        document.getElementById('sessions-list').innerHTML = 
            `<div class="empty-state" style="color: #e74c3c;">Error: ${error.message}</div>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function cleanupSessions() {
    const btn = document.getElementById('btn-cleanup');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading-spinner"></span> Cleaning...';
    btn.disabled = true;
    
    const resultEl = document.getElementById('cleanup-result');
    
    try {
        const response = await fetch('/admin/api/debug/sessions/cleanup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        resultEl.innerHTML = `<span style="color: #27ae60;">âœ“ Cleaned ${data.cleaned} session(s). ${data.remaining} remaining.</span>`;
        
        // Refresh sessions list
        await loadSessions();
    } catch (error) {
        resultEl.innerHTML = `<span style="color: #e74c3c;">Error: ${error.message}</span>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function loadRagStatus() {
    const btn = document.getElementById('btn-refresh-rag');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading-spinner"></span> Loading...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/admin/api/debug/rag');
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update status
        const statusEl = document.getElementById('figure-manager-status');
        if (data.figure_manager_initialized) {
            statusEl.textContent = 'âœ“ Initialized';
            statusEl.className = 'stat-value success';
        } else {
            statusEl.textContent = 'âœ— Not initialized';
            statusEl.className = 'stat-value error';
        }
        
        // Update figures list
        const figuresEl = document.getElementById('figures-list');
        if (data.figures && data.figures.length > 0) {
            figuresEl.innerHTML = data.figures.map(f => `
                <div class="figure-item">
                    <span>${f.name}</span>
                    <span style="color: ${f.document_count > 0 ? '#27ae60' : '#999'};">
                        ${f.document_count} docs
                    </span>
                </div>
            `).join('');
        } else {
            figuresEl.innerHTML = '<div class="empty-state">No figures found</div>';
        }
        
        // Update errors
        const errorsContainer = document.getElementById('rag-errors');
        const errorsList = document.getElementById('rag-errors-list');
        if (data.errors && data.errors.length > 0) {
            errorsContainer.style.display = 'block';
            errorsList.innerHTML = data.errors.map(e => `<li>${e}</li>`).join('');
        } else {
            errorsContainer.style.display = 'none';
        }
        
        updateRefreshTime();
    } catch (error) {
        document.getElementById('figures-list').innerHTML = 
            `<div class="empty-state" style="color: #e74c3c;">Error: ${error.message}</div>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

async function rebuildBm25() {
    const btn = document.getElementById('btn-rebuild-bm25');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="loading-spinner"></span> Rebuilding...';
    btn.disabled = true;
    
    const resultEl = document.getElementById('bm25-result');
    resultEl.innerHTML = '';
    
    try {
        const response = await fetch('/admin/api/debug/rebuild-bm25', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        });
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        let details = data.results.map(r => 
            `${r.name}: ${r.success ? 'âœ“' : 'âœ—' + (r.error ? ' ' + r.error : ' no documents')}`
        ).join('<br>');
        
        resultEl.innerHTML = `<span style="color: #27ae60;">âœ“ Rebuilt ${data.rebuilt}/${data.total} indexes</span><br><small style="color: #666;">${details}</small>`;
    } catch (error) {
        resultEl.innerHTML = `<span style="color: #e74c3c;">Error: ${error.message}</span>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSessions();
    loadRagStatus();
});
</script>
{% endblock %}

