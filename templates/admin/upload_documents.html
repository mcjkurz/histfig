{% extends "admin/base.html" %}

{% block title %}Upload Documents - {{ figure.name }} - Historical Figures Admin{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Upload Documents for {{ figure.name }}</h2>
        <div style="display: flex; gap: 0.5rem;">
            <a href="{{ url_for('figure_detail', figure_id=figure.figure_id) }}" class="btn btn-secondary">← Back to Figure</a>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">Dashboard</a>
        </div>
    </div>
    <div class="card-body">
        <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('upload_documents', figure_id=figure.figure_id) }}" accept-charset="utf-8">
            <div class="file-upload">
                <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Select Documents to Upload</h3>
                <p style="color: #666; margin-bottom: 2rem;">Choose PDF or text files containing this figure's writings, speeches, letters, or other relevant content.</p>
                
                <input type="file" id="fileInput" name="files" multiple accept=".pdf,.txt,.text" required
                       style="margin: 1rem 0; padding: 0.5rem; border: 2px solid #ddd; border-radius: 4px; width: 100%; max-width: 400px;">
                
                <div style="margin-top: 1rem;">
                    <button type="submit" id="uploadButton" class="btn btn-success" style="padding: 1rem 2rem; font-size: 1rem;">
                        Upload & Process Documents
                    </button>
                </div>
            </div>
        </form>
        
        <!-- Progress Section (hidden by default) -->
        <div id="progressSection" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
            <h4 style="color: #2c3e50; margin-bottom: 1rem;">Upload Progress</h4>
            <div id="progressContainer"></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Upload Guidelines</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #27ae60;">
                <h4 style="color: #27ae60; margin-bottom: 1rem;">Supported Files</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: #155724;">
                    <li><strong>PDF files</strong> (.pdf) - Automatically extracted</li>
                    <li><strong>Text files</strong> (.txt, .text) - Direct processing</li>
                    <li><strong>Multiple files</strong> - Upload several at once</li>
                    <li><strong>Max size:</strong> 50MB per file</li>
                </ul>
            </div>
            
            <div style="background: #d1ecf1; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3498db;">
                <h4 style="color: #0c5460; margin-bottom: 1rem;">Best Practices</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: #0c5460;">
                    <li>Use authentic historical texts when possible</li>
                    <li>Include diverse content (letters, speeches, writings)</li>
                    <li>Ensure good text quality for better results</li>
                    <li>Name files descriptively for easier management</li>
                </ul>
            </div>
            
            <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                <h4 style="color: #856404; margin-bottom: 1rem;">Processing Info</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: #856404;">
                    <li>Documents are automatically chunked</li>
                    <li>Text is processed and vectorized</li>
                    <li>Multiple chunks created per document</li>
                    <li>Processing happens immediately after upload</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Recommended Document Types</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                <h5 style="color: #2c3e50;">Personal Writings</h5>
                <p style="font-size: 0.9rem; color: #666; margin: 0;">Diaries, journals, personal letters, memoirs</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                <h5 style="color: #2c3e50;">Public Speeches</h5>
                <p style="font-size: 0.9rem; color: #666; margin: 0;">Political speeches, public addresses, declarations</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                <h5 style="color: #2c3e50;">Published Works</h5>
                <p style="font-size: 0.9rem; color: #666; margin: 0;">Books, essays, philosophical treatises</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;"></div>
                <h5 style="color: #2c3e50;">Correspondence</h5>
                <p style="font-size: 0.9rem; color: #666; margin: 0;">Letters to colleagues, friends, family</p>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>What Happens Next?</h3>
    </div>
    <div class="card-body">
        <div style="background: #f8f9fa; padding: 2rem; border-radius: 8px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; text-align: center;">
                <div>
                    <div style="background: #3498db; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-weight: bold;">1</div>
                    <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">Upload</h5>
                    <p style="font-size: 0.9rem; color: #666; margin: 0;">Files are securely uploaded to the server</p>
                </div>
                
                <div>
                    <div style="background: #3498db; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-weight: bold;">2</div>
                    <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">Process</h5>
                    <p style="font-size: 0.9rem; color: #666; margin: 0;">Text is extracted and intelligently chunked</p>
                </div>
                
                <div>
                    <div style="background: #3498db; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-weight: bold;">3</div>
                    <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">Vectorize</h5>
                    <p style="font-size: 0.9rem; color: #666; margin: 0;">Content is converted to searchable vectors</p>
                </div>
                
                <div>
                    <div style="background: #27ae60; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-weight: bold;">✓</div>
                    <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">Ready</h5>
                    <p style="font-size: 0.9rem; color: #666; margin: 0;">Figure is ready for personalized conversations</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .file-progress {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .file-progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .file-progress-name {
        font-weight: bold;
        color: #2c3e50;
    }
    
    .file-progress-status {
        font-size: 0.9rem;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
    }
    
    .status-processing {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-success {
        background: #d4edda;
        color: #155724;
    }
    
    .status-error {
        background: #f8d7da;
        color: #721c24;
    }
    
    .progress-bar-container {
        width: 100%;
        height: 30px;
        background: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin: 0.5rem 0;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #3498db, #2980b9);
        border-radius: 15px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
        min-width: 40px;
    }
    
    .progress-bar.success {
        background: linear-gradient(90deg, #27ae60, #229954);
    }
    
    .progress-bar.error {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
    }
    
    .chunk-info {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }
    
    .upload-summary {
        margin-top: 1.5rem;
        padding: 1rem;
        background: #e8f5e9;
        border-left: 4px solid #27ae60;
        border-radius: 4px;
    }
    
    .upload-summary.has-errors {
        background: #fff3cd;
        border-left-color: #ffc107;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.6; }
        100% { opacity: 1; }
    }
    
    .processing-animation {
        animation: pulse 1.5s infinite;
    }
</style>

<script>
    // Modern upload with progress tracking
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const uploadButton = document.getElementById('uploadButton');
    const progressSection = document.getElementById('progressSection');
    const progressContainer = document.getElementById('progressContainer');
    
    // File upload validation and preview
    fileInput.addEventListener('change', function(e) {
        const files = e.target.files;
        const fileList = document.getElementById('file-list');
        
        if (files.length > 0) {
            // Create file preview if it doesn't exist
            let preview = document.getElementById('file-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'file-preview';
                preview.style.marginTop = '1rem';
                preview.style.padding = '1rem';
                preview.style.background = 'white';
                preview.style.borderRadius = '8px';
                preview.style.border = '1px solid #ddd';
                this.parentNode.appendChild(preview);
            }
            
            preview.innerHTML = '<h5 style="margin-bottom: 1rem; color: #2c3e50;">Selected Files:</h5>';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileInfo = document.createElement('div');
                fileInfo.style.padding = '0.5rem';
                fileInfo.style.background = '#f8f9fa';
                fileInfo.style.borderRadius = '4px';
                fileInfo.style.marginBottom = '0.5rem';
                fileInfo.style.display = 'flex';
                fileInfo.style.justifyContent = 'space-between';
                fileInfo.style.alignItems = 'center';
                
                const icon = file.type === 'application/pdf' ? '' : '';
                const size = (file.size / 1024 / 1024).toFixed(2);
                
                fileInfo.innerHTML = `
                    <span>${file.name}</span>
                    <span style="color: #666; font-size: 0.8rem;">${size} MB</span>
                `;
                
                preview.appendChild(fileInfo);
            }
        }
    });

    // AJAX upload with progress tracking
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const files = fileInput.files;
        
        if (files.length === 0) {
            alert('Please select at least one file to upload!');
            return;
        }
        
        // Check file sizes
        for (let i = 0; i < files.length; i++) {
            if (files[i].size > 50 * 1024 * 1024) { // 50MB
                alert(`File "${files[i].name}" is too large. Maximum size is 50MB.`);
                return;
            }
        }
        
        // Prepare UI
        uploadButton.disabled = true;
        uploadButton.innerHTML = 'Uploading...';
        progressSection.style.display = 'block';
        progressContainer.innerHTML = '';
        
        // Create progress bars for each file
        const fileProgressElements = {};
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const progressId = `progress-${i}`;
            
            const progressHtml = `
                <div class="file-progress" id="${progressId}">
                    <div class="file-progress-header">
                        <span class="file-progress-name">${file.name}</span>
                        <span class="file-progress-status status-processing processing-animation">Uploading...</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 1%">0%</div>
                    </div>
                    <div class="chunk-info">Uploading to server...</div>
                </div>
            `;
            progressContainer.insertAdjacentHTML('beforeend', progressHtml);
            fileProgressElements[i] = document.getElementById(progressId);
        }
        
        // Prepare form data
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
            formData.append('files', files[i]);
        }
        
        try {
            // Use EventSource for streaming progress updates
            const streamUrl = uploadForm.action.replace('/upload', '/upload-stream');
            
            // First, upload using FormData with streaming endpoint
            const xhr = new XMLHttpRequest();
            const useStreaming = true; // Toggle this to switch between streaming and non-streaming
            
            if (useStreaming) {
                // Use fetch with EventSource for real-time updates
                fetch(streamUrl, {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    
                    function processStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                console.log('Stream complete');
                                return;
                            }
                            
                            buffer += decoder.decode(value, { stream: true });
                            const lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            for (const line of lines) {
                                if (line.startsWith('data: ')) {
                                    try {
                                        const data = JSON.parse(line.slice(6));
                                        handleStreamEvent(data);
                                    } catch (e) {
                                        console.error('Error parsing SSE data:', e);
                                    }
                                }
                            }
                            
                            processStream();
                        });
                    }
                    
                    processStream();
                }).catch(error => {
                    console.error('Stream error:', error);
                    handleUploadError(error.message);
                });
            } else {
                // Fallback to regular AJAX
                for (let i = 0; i < files.length; i++) {
                    const progressBar = fileProgressElements[i].querySelector('.progress-bar');
                    progressBar.style.width = '10%';
                    progressBar.textContent = '10%';
                    fileProgressElements[i].querySelector('.chunk-info').textContent = 'Uploading to server...';
                }
                
                const response = await fetch(uploadForm.action, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });
                
                const result = await response.json();
                handleRegularResponse(result, response.ok);
            }
            
            // Handle streaming events
            function handleStreamEvent(data) {
                const { event, file_index } = data;
                
                switch (event) {
                    case 'file_start':
                        console.log(`Starting upload for ${data.filename}`);
                        if (fileProgressElements[file_index]) {
                            const progressBar = fileProgressElements[file_index].querySelector('.progress-bar');
                            // Keep initial progress at 0% until we start processing chunks
                            progressBar.style.width = '1%';  // Just 1% to show it's active
                            progressBar.textContent = '0%';
                            fileProgressElements[file_index].querySelector('.chunk-info').textContent = 'Reading file...';
                        }
                        break;
                        
                    case 'chunks_count':
                        if (fileProgressElements[file_index]) {
                            const progressBar = fileProgressElements[file_index].querySelector('.progress-bar');
                            // Now that we know the chunks, show slight progress
                            progressBar.style.width = '2%';
                            progressBar.textContent = '0%';  // Keep text at 0% until actual processing
                            fileProgressElements[file_index].querySelector('.chunk-info').textContent = `Ready to process ${data.total_chunks} chunks...`;
                        }
                        break;
                        
                    case 'chunk_progress':
                        if (fileProgressElements[file_index]) {
                            const progressBar = fileProgressElements[file_index].querySelector('.progress-bar');
                            const progress = Math.round(data.progress);
                            progressBar.style.width = progress + '%';
                            progressBar.textContent = progress + '%';
                            fileProgressElements[file_index].querySelector('.chunk-info').textContent = 
                                `Processing chunk ${data.chunks_processed} of ${data.total_chunks}...`;
                        }
                        break;
                        
                    case 'file_complete':
                        if (fileProgressElements[file_index]) {
                            const progressEl = fileProgressElements[file_index];
                            const progressBar = progressEl.querySelector('.progress-bar');
                            const statusEl = progressEl.querySelector('.file-progress-status');
                            const chunkInfo = progressEl.querySelector('.chunk-info');
                            
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100%';
                            progressBar.classList.add('success');
                            statusEl.classList.remove('processing-animation');
                            statusEl.className = 'file-progress-status status-success';
                            statusEl.textContent = 'Complete';
                            chunkInfo.textContent = `Successfully processed ${data.chunks_added} chunks`;
                        }
                        break;
                        
                    case 'file_error':
                        if (fileProgressElements[file_index]) {
                            const progressEl = fileProgressElements[file_index];
                            const progressBar = progressEl.querySelector('.progress-bar');
                            const statusEl = progressEl.querySelector('.file-progress-status');
                            const chunkInfo = progressEl.querySelector('.chunk-info');
                            
                            progressBar.style.width = '100%';
                            progressBar.textContent = 'Error';
                            progressBar.classList.add('error');
                            statusEl.classList.remove('processing-animation');
                            statusEl.className = 'file-progress-status status-error';
                            statusEl.textContent = 'Failed';
                            chunkInfo.textContent = data.error || 'Processing failed';
                        }
                        break;
                        
                    case 'upload_complete':
                        handleUploadComplete(data.successful_uploads, data.total_files);
                        break;
                        
                    case 'error':
                        handleUploadError(data.error);
                        break;
                }
            }
            
            // Handle regular AJAX response
            function handleRegularResponse(result, isOk) {
                if (!isOk) {
                    throw new Error(result.error || 'Upload failed');
                }
                
                // Process results
                result.results.forEach((fileResult, index) => {
                    const progressEl = fileProgressElements[index];
                    const progressBar = progressEl.querySelector('.progress-bar');
                    const statusEl = progressEl.querySelector('.file-progress-status');
                    const chunkInfo = progressEl.querySelector('.chunk-info');
                    
                    statusEl.classList.remove('processing-animation');
                    
                    if (fileResult.status === 'success') {
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        progressBar.classList.add('success');
                        statusEl.className = 'file-progress-status status-success';
                        statusEl.textContent = 'Complete';
                        chunkInfo.textContent = `Successfully processed ${fileResult.total_chunks} chunks`;
                    } else {
                        progressBar.style.width = '100%';
                        progressBar.textContent = 'Error';
                        progressBar.classList.add('error');
                        statusEl.className = 'file-progress-status status-error';
                        statusEl.textContent = 'Failed';
                        chunkInfo.textContent = fileResult.error || 'Processing failed';
                    }
                });
                
                handleUploadComplete(result.successful_uploads, result.total_files);
            }
            
            // Handle upload completion
            function handleUploadComplete(successfulUploads, totalFiles) {
                // Get the figure detail URL from Jinja2 before entering the template literal
                const figureDetailUrl = "{{ url_for('figure_detail', figure_id=figure.figure_id) }}";
                
                // Add summary
                const summaryClass = successfulUploads < totalFiles ? 'has-errors' : '';
                const summaryHtml = `
                    <div class="upload-summary ${summaryClass}">
                        <h5 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Upload Summary</h5>
                        <p style="margin: 0;">
                            Successfully processed: <strong>${successfulUploads}/${totalFiles}</strong> files
                        </p>
                        ${successfulUploads > 0 ? 
                            '<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Documents have been added to the figure knowledge base.</p>' : 
                            '<p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #721c24;">Please check the errors above and try again.</p>'
                        }
                        ${successfulUploads > 0 ? 
                            `<p style="margin: 0.5rem 0 0 0;"><a href="${figureDetailUrl}" class="btn btn-primary">← Back to Figure Details</a></p>` : 
                            ''
                        }
                    </div>
                `;
                progressContainer.insertAdjacentHTML('beforeend', summaryHtml);
                
                // Reset button
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload More Documents';
            }
            
            // Handle upload error
            function handleUploadError(errorMessage) {
                console.error('Upload error:', errorMessage);
                // Show error in the progress section instead of alert
                const errorHtml = `
                    <div class="upload-summary has-errors">
                        <h5 style="margin: 0 0 0.5rem 0; color: #721c24;">Upload Failed</h5>
                        <p style="margin: 0; color: #721c24;">${errorMessage}</p>
                    </div>
                `;
                progressContainer.insertAdjacentHTML('beforeend', errorHtml);
                uploadButton.disabled = false;
                uploadButton.innerHTML = 'Upload & Process Documents';
            }
            
        } catch (error) {
            handleUploadError(error.message);
        }
    });
</script>
{% endblock %}
