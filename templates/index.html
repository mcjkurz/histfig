<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="cache-bust" content="v3.0-mobile-optimized">
    <title>RAG Chat - Historical Figures</title>
    <link rel="stylesheet" href="/static/css/chat.css">
</head>
<body>
    <div class="app-container">
        <!-- Toggle button for figure panel -->
        <button class="figure-toggle-btn" id="figure-toggle-btn" aria-label="Toggle Figure Panel">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </button>

        <!-- Toggle button for control panel -->
        <button class="control-toggle-btn" id="control-toggle-btn" aria-label="Toggle Control Panel">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <!-- Overlay for mobile -->
        <div class="overlay" id="overlay"></div>

        <!-- Figure panel -->
        <div class="figure-panel" id="figure-panel">
            <div class="figure-header">
                <h2>Historical Figure</h2>
            </div>
            <div class="figure-content">
                <div class="figure-empty" id="figure-empty">
                    <p>No figure selected</p>
                    <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.7;">Select a historical figure from the settings panel to see their information here.</p>
                </div>
                <div class="figure-info" id="figure-info">
                <img class="figure-image" id="figure-image" src="" alt="Figure Portrait" style="display: none;">
                <div class="figure-name" id="figure-display-name"></div>
                <div class="figure-years" id="figure-years"></div>
                <div class="figure-description" id="figure-display-description"></div>
                <div class="figure-personality" id="figure-display-personality"></div>
                </div>
            </div>
        </div>

        <!-- Main chat container -->
        <div class="chat-container">
            <div class="chat-header">
                <h1>Historical Figures Chat</h1>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="status-indicator" style="display: none;">
                        <div class="status-dot" id="status-dot"></div>
                        <span class="status-text" id="status-text">Connecting...</span>
                    </div>
                    <button class="save-conversation-btn" id="save-conversation-btn" title="Save conversation as PDF">
                        Save
                    </button>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
            </div>

            <div class="chat-input-container">
            <form class="chat-input-form" id="chat-form">
                <textarea
                    class="chat-input"
                    id="message-input"
                    placeholder="Type your message here..."
                    rows="1"
                ></textarea>
                <button type="submit" class="send-button" id="send-button">Send</button>
                <button type="button" class="stop-button" id="stop-button" style="display: none;">Stop</button>
            </form>
            </div>
        </div>

        <!-- Control panel -->
        <div class="control-panel" id="control-panel">
            <div class="control-header">
                <h2>Settings</h2>
                <button class="control-close-btn" id="control-close-btn" aria-label="Close">×</button>
            </div>
            <div class="control-content">
                <!-- Figure Selection -->
                <div class="control-section">
                    <div class="control-section-header">Historical Figure</div>
                    <div class="control-section-content">
                        <div class="control-item">
                            <label class="control-label">Select Figure</label>
                            <select id="figure-select" class="control-select">
                                <option value="">Loading figures...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Model Selection -->
                <div class="control-section">
                    <div class="control-section-header">AI Model</div>
                    <div class="control-section-content">
                        <div class="control-item">
                            <label class="control-label">Source</label>
                            <select id="model-source-select" class="control-select">
                                <option value="external">External API</option>
                                <option value="local">Local</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label class="control-label">Select Model</label>
                            <select id="model-select" class="control-select">
                                <option value="">Loading models...</option>
                            </select>
                            <input type="text" id="custom-model-name" class="control-input" 
                                   placeholder="Enter custom model name" 
                                   style="display: none; margin-top: 10px;">
                        </div>
                        
                        <!-- External API Configuration (shown when external source selected) -->
                        <div id="external-api-config" style="margin-top: 15px;">
                            <div class="control-item">
                                <label class="control-label">API Endpoint</label>
                                <input type="text" id="external-api-url" class="control-input" 
                                       placeholder="https://api.poe.com/v1" 
                                       value="https://api.poe.com/v1">
                            </div>
                            <div class="control-item">
                                <label class="control-label">API Key</label>
                                <input type="password" id="external-api-key" class="control-input" 
                                       placeholder="Enter your API key">
                                <div id="api-key-status" style="margin-top: 5px; font-size: 11px; display: none;">
                                    <span style="color: #e74c3c;">⚠️ API key is required to use External API</span>
                                </div>
                                <small style="color: #95a5a6; font-size: 11px; display: block; margin-top: 5px;">
                                    Your API key is sent directly to the external API and not stored.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Options -->
                <div class="control-section">
                    <div class="control-section-header">Chat Options</div>
                    <div class="control-section-content">
                        <div class="control-item">
                            <div class="control-toggle" id="rag-toggle-container">
                                <div class="toggle-switch active" id="rag-toggle-switch">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span class="toggle-label">Enable RAG</span>
                            </div>
                            <div style="margin-top: 5px;">
                                <span style="font-size: 0.75rem; color: #a8c5d9;" id="rag-status">0 docs</span>
                                <span style="font-size: 0.7rem; color: #e74c3c; display: none;" id="rag-config-disabled"> (disabled in config)</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label class="control-label">Documents to Retrieve</label>
                            <select id="docs-count-select" class="control-select">
                                <option value="5">Loading...</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <div class="control-toggle" id="query-augmentation-toggle-container">
                                <div class="toggle-switch active" id="query-augmentation-toggle-switch">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span class="toggle-label">Query Augmentation</span>
                            </div>
                            <div style="margin-top: 5px;">
                                <span style="font-size: 0.7rem; color: #e74c3c; display: none;" id="query-augmentation-config-disabled">Disabled in config</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <div class="control-toggle" id="thinking-toggle-container">
                                <div class="toggle-switch active" id="thinking-toggle-switch">
                                    <div class="toggle-slider"></div>
                                </div>
                                <span class="toggle-label">Show Thinking</span>
                            </div>
                        </div>
                        <div class="control-item">
                            <label class="control-label">Thinking Intensity</label>
                            <select id="thinking-intensity-select" class="control-select">
                                <option value="none">None</option>
                                <option value="low">Low</option>
                                <option value="normal" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label class="control-label">Response Temperature</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="1.0" style="flex: 1;">
                                <span id="temperature-value" style="min-width: 35px; text-align: right; color: #7dd3fc; font-weight: 600;">1.0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.75rem; color: #a8c5d9;">
                                <span>Focused</span>
                                <span>Balanced</span>
                                <span>Creative</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Augmented Query Panel -->
                <div class="augmented-query-panel" id="augmented-query-panel" style="display: none;">
                    <div class="documents-header">
                        <h3>Augmented Query <span id="augmented-query-model" style="font-weight: normal; font-size: 0.8em; color: #6b8fa3;"></span></h3>
                    </div>
                    <div class="documents-content" id="augmented-query-content">
                        <div id="augmented-query-text" style="color: #a8c5d9; font-size: 0.85rem; line-height: 1.5; white-space: pre-wrap;"></div>
                    </div>
                </div>

                <!-- Retrieved Documents -->
                <div class="documents-panel" id="documents-panel">
                    <div class="documents-header">
                        <h3>Retrieved Documents</h3>
                    </div>
                    <div class="documents-content" id="documents-content">
                        <div class="documents-empty" id="documents-empty" style="color: #a8c5d9; font-size: 0.85rem; text-align: center; padding: 20px;">
                            No documents retrieved yet. Send a message with RAG enabled to see relevant documents here.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Modal -->
    <div id="source-modal" class="source-modal">
        <div class="source-modal-content">
            <div class="source-modal-header">
                <div class="source-modal-title" id="source-modal-title"></div>
                <button class="source-modal-close" id="source-modal-close">&times;</button>
            </div>
            <div class="source-modal-text" id="source-modal-text"></div>
        </div>
    </div>

    <!-- Include the chat application JavaScript -->
    <script src="/static/chat-app.js"></script>
</body>
</html>
